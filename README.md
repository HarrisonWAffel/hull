hull
========

[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

Hull is a **Go testing framework** for writing comprehensive tests on [Helm](https://github.com/helm/helm) charts.

Once you have defined your suite of tests targeting a specific chart (or multiple charts) using Hull, **you can simply run your suite(s) of tests by running `go test`**.

## Prerequisites

You will be expected to install the following dependencies locally on your machine to successfully run Hull:
* [Go](https://go.dev) (minimal requirement to be able to run `go test`)
* [Yamllint](https://github.com/adrienverge/yamllint) (allows Hull to run YAML linting on manifests produced by `helm template` commands)

## Getting Started

Please see [`examples/example_test.go`](./examples/example_test.go) for an example of a Go test written for a single chart in this fashion on the chart located in [`testdata/charts/example-chart`](./testdata/charts/example-chart/). To run the example test, you can simply run:

```bash
go test examples/example_test.go
```

Under the hood, Hull leverages [`github.com/stretchr/testify/assert`](github.com/stretchr/testify/assert) for test assertions; it is recommended, but not required, for users to also use this framework when designing Hull tests.

## How Does Hull Work?

For more information on the overall testing methodology that Hull follows, see the [Design guide](docs/design.md).

## Who needs Hull?

Anyone who maintains a Helm repository or a set of Helm charts that would like to add an automated testing suite that allows them to validate the following basic, core functionality:

- **Linting:** Ensure that the Helm chart passes a basic `helm lint` command and that basic, common values.yaml configurations of the Helm charts (encoded in `TemplateOptions` within a `Case`) compile to YAML that passes stylistic linting checks, without validating the actual content of the YAML produced from a logical perspective. 
  - On a failure, if `export TEST_OUTPUT_DIR=output` is set, generate an `output/test-{TIMESTAMP}.md` file that outlines the linting error on **each rendered template file** that failed validation on YAML linting, along with the error outputted, for easy debugging.

- **Unit Testing:** Ensure that the Kubernetes manifest produced by running the `helm template` command on basic, common values.yaml configurations (encoded in `TemplateOptions` within a `Case`) applied to the Helm charts generates YAML that matches the expectations of chart developers (encoded in `Checks` within a `Case`) from a logical perspective. Also ensure that all possible `Cases` pass a basic set of `Checks` (encoded in `DefaultChecks`)
  - Example of a `DefaultCheck`: Resources follow best practices that allow them to be deployed onto specialized environments (i.e. Deployments have nodeSelectors and tolerations for Windows)
  - Example of a `DefaultCheck`: Resources meet other business-specific requirements (i.e. all images start with rancher/mirrored- unless they belong on an allow-list of Rancher original images)

> **Note:**
>
> When it comes to a chart developer defining a `Check` in Hull, Hull is **extremely permissive** with respect to how a chart developer can choose to write their tests. 
>
> Under the hood, Hull accepts any `CheckFunc`, which is just an `interface{}` (i.e. any Golang object!), and will perform the validation of the `CheckFunc` **at runtime** based on the logic encoded in [`pkg/checker/internal/do.go`](./pkg/checker/internal/do.go).
>
> **TLDR**: As long as your `CheckFunc` matches a signature of `func(*testing.T, someRuntimeObjectStruct)` where `someRuntimeObjectStruct` is any struct that contains only slices of objects that implement [`k8s.io/apimachinery/pkg/runtime.Object`](https://pkg.go.dev/k8s.io/apimachinery/pkg/runtime#Object) **somewhere in the struct**, Hull will automatically manage marshalling your generated template objects into the provided struct for your tests.
>
> In this way, Hull encourages chart developers to think of changes applied to `values.yaml` as changes to **sub-manifests**: specific sets of resource types encoded in `someRuntimeObjectStruct`. 
>
> For example, if a field in your values.yaml should ensure that "all Deployments should have a specific set of user-provided `metadata.labels` attached to them", you will want to define a `CheckFunc` with a signature like `func(*testing.T, struct{ []*appsv1.Deployment })`.
>
> For examples of such tests, take a look at the [`pkg/checker/resource`](./pkg/checker/resource) module that encodes these tests for common Kubernetes resource types.

> **Note:**
>
> On writing your own custom `CheckFunc`, you will need to ensure that you add any Go types to the `pkg/checker.Scheme` defined [here](./pkg/checker/checker.go).
>
> This is usually done by running the `AddToScheme` function usually generated by most Go-based Kubernetes controller frameworks; for example, if you have `import appsv1 "k8s.io/api/apps/v1"` in your code to embed an `*[]appsv1.Deployment`, you can call `appsv1.AddToScheme(checker.Scheme)` to load the type into the default scheme.
>
> Without adding a type to the underlying `checker.Scheme`, Hull will not be able to figure out what type a specific object within a manifest should be marshalled into; this is generally done by converting the `apiVersion` and `kind` fields of a given YAML object into a `GroupVersionKind` (GVK), which in turn can be passed into the [`runtime.Scheme`](https://pkg.go.dev/k8s.io/apimachinery/pkg/runtime#Scheme) to map that GVK to a corresponding Go struct.
>
> If a type cannot be found in the `checker.Scheme`, it will **always** be assumed that your object is of type [`*unstructured.Unstructured`](https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1/unstructured#Unstructured).
>
> **Alternatively, it is highly recommended to define structs that simply embed the structs defined in `pkg/resources`, which already take care of these imports on `init()` for you.**

- **Schema Validation**: Ensure that the Helm chart has a `values.schema.json` (or **automatically manage the creation and maintainence of one**) that matches a Go `struct` that is defined in your Go tests (encoded in `ValuesStruct`).
  - If the `ValuesStruct` is defined, Hull will automatically assert that **every single field in your values.yaml has a corresponding `Case` that tests it**. If there is no `Case` that tests a specific field, the fields within your `values.yaml` that are not tested will be outputted in a failure message on running `TestCoverage`.

### Currently Unsupported (To Be Implemented)

The following types of tests are in scope for the expected use cases that Hull can **eventually** address around Helm chart testing, but are not currently supported:

- **Security Testing:** Add support for additional helper functions for chart developers to use in [`pkg/checker/resource`](./pkg/checker/resource) to verify that all workloads in a given rendered template manifest do not contain any known CVEs associated with them by running a `trivy` image scan on all images. Also add additional helper functions to encode best practices for workloads in Helm charts.

- **Install Testing / Smoke Testing:** Upon installing a helm chart onto a cluster using basic, common values.yaml configurations of Helm charts, ensure that all pods are up and running (`helm install --wait`) and that a `helm test` is successfully executed. Also ensure that upgrades from the second newest version of a chart (if it exists) to the latest version of the chart work if a given `values.yaml` exists in both the newer and older chart and that in-place upgrades work.
  - Note: it is expected that your Helm chart must already have `helm test` hook resources that verify that all exposed endpoints of your application can be accessed via some k8s Service using Kubernetes DNS directly from within the cluster and that any known endpoints that indicate application status (i.e. a /health endpoint) return a valid response that indicates that the endpoint is healthy, if available. See the [Grafana Helm chart](https://github.com/grafana/helm-charts/tree/main/charts/grafana/templates/tests) or [MySQL Helm chart](https://github.com/helm/charts/tree/master/stable/mysql/templates/tests) for simple examples of how to add this type of testing via [Bats](https://github.com/bats-core/bats-core)

- **Integration / Vanilla K8s Testing:** Upon installing a helm chart onto a cluster using basic, common values.yaml configurations of Helm charts, ensure that user workflows work as expected
  - e.g. Mimic a user creating a certain resource via kubectl and validate that some configuration is modified correctly (a Kubernetes resource is created / modified, a log is emitted, a file is created / modified within a container, the output of a specific HTTP call returns the desired result, etc.)

## Developing

### Which branch do I make changes on?

Hull is built and released off the contents of the `main` branch. To make a contribution, open up a PR to the `main` branch.

For more information, see the [Developing guide](docs/developing.md).

## Building

`make`


## Running

`./bin/hull`

## License
Copyright (c) 2022 [Rancher Labs, Inc.](http://rancher.com)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

[http://www.apache.org/licenses/LICENSE-2.0](http://www.apache.org/licenses/LICENSE-2.0)

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
